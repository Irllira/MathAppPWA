@page "/FractionsRed"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using global::FrontEnd.Components.Classes
@using global::FrontEnd.Components.Pages.Games.Fractions
@rendermode InteractiveServer
@inherits FractionReductionBase;
@inject NavigationManager NavManager


<PageTitle>Skracanie Ułamków</PageTitle>


@if(ready==true)
{
    if(part == "multi"){
        <h1 style="text-align:center">Wybierz Liczbę Przez Którą Jest Podzielny Dzielnik i Mianownik</h1>
        <p style="height:10px"></p>
        <h2><b> 
            <div class="frac"> 
                <span>@numerator</span>  
                <span class="symbol">/</span>
                <span class="bottom"> @denominator </span> 
            </div>   = 
        </b></h2>
        <p style="height:5px"></p>

        Random rnd = new Random();
        int correct = rnd.Next(0,wrongMultiply.Count()+1);
        int j = 0;
        for (int i=0;i<wrongMultiply.Count()+1;i++)
        {
            if (i == correct)
            {
                <button class="btn btn-primary" @onclick="GoodPartOne">@multiply</button> <label style="padding-left:20px"></label>
            }else
            {
                <button class="btn btn-primary" @onclick ="gameBase.WrongAnswer">@wrongMultiply[j]</button> <label style="padding-left:20px"></label>
                j++;
            }
        }
    }else
    {
        <h1 style="text-align:center">Teraz Podaj Wynik</h1>
        <p style="height:10px"></p>

        <h2><b>
        <div class="frac"> 
            <span>@numerator </span> 
            <span class="symbol">/</span>
            <span class="bottom"> @denominator </span> 
        </div>
         = 
        </b>
        <div class="frac"> 
            <span><InputNumber @bind-Value="UserNum" @onkeydown="@Enter" style="width:50px;font-size:20px" /></span>  
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="UserDen" @onkeydown="@Enter" style="width:50px;font-size:20px" /> </span> </div>
        </h2>

        <p style="height:5px"></p>
        <button class="confbtn" @onclick="CheckAnwsers">Potwierdź</button>
        
      
    }
    <p style="height:5px"></p>
    <p>@gameBase.message</p>
    <p style="height:5px"></p>
    <p>Wynik: @gameBase.good / @gameBase.all </p>
}else
{
    <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
    <p style="height:10px"></p>
    <h4>Twój wynik to: @gameBase.good / @gameBase.all </h4>
}

<p style="height:50px"></p>
<button class="backbtn" @onclick="GoBack">Cofnij</button>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    GamesBase gameBase = new GamesBase("Ułamki","Gry");
    private int UserDen;
    private int UserNum;


    private async Task GoodPartOne()
    {
        gameBase.message = "Dobrze! Teraz podaj wynik!";
        UserNum = 0;
        UserDen = 0;

        await Task.Delay(1000);
        part = "final";
        gameBase.message = "";
    }

    private async Task CheckAnwsers()
    {
        string a = UserNum + " / " + UserDen;

        if (a == correctNumber)
        {
            await gameBase.GoodAnswer();
            if (gameBase.all >= 10)
            {
                ready = false;
                await gameBase.UpdateUserScore(authenticationStateTask, userProgressService);
                return;
            }
            PrepareNewGame();
            part = "multi";
            UserNum = 0;
            UserDen = 0;
            return;
        }
        else
        {
            double x = (double)UserNum / UserDen;
            double y = (double)numerator / denominator;
            if (x == y)
            {
                await CloseNumber();
            }
            else
            {
                await gameBase.WrongAnswer();
                UserNum = 0;
                UserDen = 0;
            }
        }
    }

    private async Task CloseNumber()
    {
        gameBase.message = "Prawie! Ułamek można skrócić jeszcze bardziej!";
        numerator = UserNum;
        denominator = UserDen;
        UserNum = 0;
        UserDen = 0;
        this.StateHasChanged();


        await Task.Delay(1000);
        gameBase.message = "";
    }

    public async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Task.Delay(500);
            await CheckAnwsers();
        }
    }

    private async Task GoBack()
    {
        await gameBase.UpdateUserScore(authenticationStateTask, userProgressService);
        NavManager.NavigateTo("ChooseGame/uname/Ułamki");
    }
}
