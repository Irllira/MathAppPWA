@page "/MixedFractions"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using global::FrontEnd.Components.Pages.Games.Fractions
@rendermode InteractiveServer
@inherits MixedFractionsBase;
@inject NavigationManager NavManager


<PageTitle>Ułamki Mieszane</PageTitle>


@if(ready==true)
{
    <h1 style="text-align:center">Podaj Poprawną Liczbę </h1>
    <p style="height:10px"></p>

    if(type == "to"){

        if (showHelp == true)
        {
            <right>
                <h4>Pomoc:</h4>
                <p style="height:5px"></p>
                <p style="font-size:20px">Ile @ExcerciseDenominator mieści się w @ExcerciseNumerator?  <InputNumber @bind-Value="@UserFullNumber" style="width:50px;font-size:15px"></InputNumber></p>
                <p style="font-size:20px"> Reszta z dzielenia @ExcerciseNumerator przez <InputNumber @bind-Value="@UserFullNumber" style="width:50px;font-size:15px"></InputNumber> to: <InputNumber @bind-Value="@UserNum" style="width:50px;font-size:15px"></InputNumber></p>
            </right>
        }else
        {
            <right></right>
        }

        <left>
        <h2 ><b> 
            <div class="frac"> 
                <span>@ExcerciseNumerator</span>  
                <span class="symbol">/</span>
                <span class="bottom"> @ExcerciseDenominator </span> 
            </div>=

            <InputNumber @bind-Value="@UserFullNumber"  style="width:50px;font-size:20px"></InputNumber>
            <div class="frac">
                <span> <InputNumber @bind-Value="@UserNum"  style="width:50px;font-size:20px"></InputNumber> </span>
                <span class="symbol">/</span>
                <span class="bottom"> <InputNumber @bind-Value="@UserDen"  style="width:50px;font-size:20px"></InputNumber> </span>
            </div>
            </b></h2>
            <p style="height:5px"></p>
            <button class="confbtn" @onclick="Confirm">Potwierdź</button>
            <p></p>
            <button class="game2btns" @onclick="Help">Pomoc</button>

            <p style="height:5px"></p>
            <p>@message</p>
            <p style="height:5px"></p>
            <p>Wynik: @good / @all </p>
        </left>
    } else
    {
        if (showHelp == true)
        {
            <right>
                <h4>Pomoc:</h4>
                <p style="height:5px"></p>
                <p style="font-size:20px">@ExcerciseDenominator * @ExcerciseFullNumber = <InputNumber @bind-Value="@help" style="width:50px;font-size:15px"></InputNumber></p>
                <p style="font-size:20px"><InputNumber @bind-Value="@help" style="width:50px;font-size:15px"></InputNumber> + @ExcerciseNumerator =  <InputNumber @bind-Value="@UserNum" style="width:50px;font-size:15px"></InputNumber></p>
            </right>
        }else
        {
            <right></right>
        }

        <left>
         <h2 ><b> @ExcerciseFullNumber
            <div class="frac"> 
                <span>@ExcerciseNumerator</span>  
                <span class="symbol">/</span>
                <span class="bottom"> @ExcerciseDenominator </span> 
            </div>=

            <div class="frac">
                <span> <InputNumber @bind-Value="@UserNum"  style="width:50px;font-size:20px"></InputNumber> </span>
                <span class="symbol">/</span>
                <span class="bottom"> <InputNumber @bind-Value="@UserDen"  style="width:50px;font-size:20px"></InputNumber> </span>
            </div>
        </b></h2>
            <p style="height:5px"></p>
            <button class="confbtn" @onclick="Confirm">Potwierdź</button>
            <p></p>
            <button class="game2btns" @onclick="Help">Pomoc</button>

            <p style="height:5px"></p>
            <p>@message</p>
            <p style="height:5px"></p>
            <p>Wynik: @good / @all </p>
        </left>       
    }

 /*   <p style="height:5px"></p>
    <button class="confbtn" @onclick="Confirm">Potwierdź</button>
    <p></p>
    <button class="game2btns" @onclick="Help">Pomoc</button>

    <p style="height:5px"></p>
    <p>@message</p>
    <p style="height:5px"></p>
    <p>Wynik: @good / @all </p>*/
}else
{
    <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
    <p style="height:10px"></p>
    <h4>Twój wynik to: @good / @all </h4>

    <p style="height:20px"></p>
    <button class="backbtn" @onclick="GoBack">Cofnij</button>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    int good = 0;
    int all = 0;
    private string message = "";

    private int help;
    private int UserDen;
    private int UserNum;
    private int UserFullNumber;

    private bool showHelp = false;

    private async Task Confirm()
    {
        if (UserDen == AnwserDenominator && UserNum == AnwserNumerator && (UserFullNumber == AnwserFullNumber || type == "from"))
        {
            await GoodNumber();
        }else
        {
            await WrongNumber();
        }
    }

    private async Task GoodNumber()
    {
        good++;
        all++;
        message = "Dobrze!";
        this.StateHasChanged();
        if (all >= 10)
        {
            ready = false;
            await Task.Delay(1500);
            message = "";
            await UpdateUserScore();
            this.StateHasChanged();
            return;
        }

        await Task.Delay(1500);
        PrepareNewGame();
        message = "";
        UserDen = 0;
        UserNum=0;
        UserFullNumber = 0;
        help = 0;
        showHelp = false;

        this.StateHasChanged();

    }
    private async Task WrongNumber()
    {
        all++;
        message = "Zła Odpowiedź! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        message = "";
    }

    private void Help()
    {
        if (showHelp == true)
        {
            showHelp = false;
        }else
        {
            showHelp = true;
        }
    }
    private async Task UpdateUserScore()
    {
        var g = good;
        var a = all;
        var authenticationState = await authenticationStateTask;
        string username = authenticationState.User.Identity.Name;
        if (username != null)
        {
            var progrss = await userProgressService.GetProgressByAll(username, "Ułamki", "Gry");
            if (progrss != null)
            {
                g += progrss.good;
                a += progrss.all;
                var updated = new UserProgressDTO() { Id = progrss.Id, AccountId = progrss.AccountId, type = "Gry", unitName = "Ułamki", all = a, good = g };
                await userProgressService.UpdateProgress(updated);

            }
            else
            {
                await userProgressService.AddProgressByName(username, "Ułamki", "Gry", good, all);
            }

        }
    }



    private void GoBack()
    {
        NavManager.NavigateTo("ChooseGame/uname/Ułamki");
    }
}
