@page "/commondivs"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer
@inherits CommonDivBase;
@inject NavigationManager NavManager


<PageTitle>Wspólny Dzielnik</PageTitle>

<h1 style="text-align:center">Znajdź NWD i NWW Liczb @excerciseNumber1 i @excerciseNumber2</h1>

@if(ready==true)
{
    <left>
        <h3> Podaj najmniejszy dzielnik liczby  </h3>

    @for(int i=0;i<=numberNumbers1;i++)
     {
        var r = i;

        if (i == numberNumbers1 && num1 == false)
        {
                <p style="font-size:20px"> <b> @divNumbers1[r] : <InputNumber @bind-Value="@userNumbers1[r]" style="width:50px" @onkeydown="@Enter1"></InputNumber>   </b></p>
        }else
        {
            <p style="font-size:20px"> <b> @divNumbers1[r] : @userNumbers1[r]  </b></p>
        }  
    }
        @if (num1 == true)
        {
            <p style="font-size:20px"> <b> 1  </b></p>
        }


        else
        {
            <button class="confbtn" @onclick="Confirm1">Potwierdź</button>
            <p style="height:5px"></p>
        }

        <p>@message1</p>
    </left>


    <right>
        <h3> Podaj najmniejszy dzielnik liczby  </h3>

        @for (int i = 0; i <= numberNumbers2; i++)
        {
            var r = i;

            if (i == numberNumbers2 && num2 == false)
            {
                <p style="font-size:20px"> <b> @divNumbers2[r] : <InputNumber @bind-Value="@userNumbers2[r]" style="width:50px" @onkeydown="@Enter2"></InputNumber>   </b></p>
            }
            else
            {
                <p style="font-size:20px"> <b> @divNumbers2[r] : @userNumbers2[r]  </b></p>
            }
        }
        @if(num2 == true)
        {
            <p style="font-size:20px"> <b> 1  </b></p>
        }else
        {
            <button class="confbtn" @onclick="Confirm2">Potwierdź</button>
            <p style="height:5px"></p>
        }
        
        <p>@message2</p>

    </right>

    if (part2==true)
    {
        <p style="font-size:20px">
            <b>
            @excerciseNumber1 =
            @for (int i = 0;i< divNumbers1.Count-1;i++)
            {
                if (i != divNumbers1.Count() - 2)
                {
                    <label> @userNumbers1[i] * </label>
                }else
                {
                    <label> @userNumbers1[i] </label>
                }
            }
            </b>
        </p>
        <p style="font-size:20px"> 
            <b>
            @excerciseNumber2 =
            @for (int i = 0; i < divNumbers2.Count-1; i++)
            {
                if (i != divNumbers2.Count() - 2)
                {
                    <label> @userNumbers2[i] * </label>
                }
                else
                {
                    <label> @userNumbers2[i] </label>
                }
            }
            </b>
        </p>

        <p>Największy Wspólny Dzielnik :
            @if (nwdList.Count!=1)
            {
                for(int i=0;i<nwdList.Count;i++)
                {
                    var j = i;
                    <InputNumber @bind-Value="@nwdUserList[j]" style="width:50px"></InputNumber>
                    if(i!=nwdList.Count-1)
                    {
                        <label> * </label>
                    }
                }   
                <label> = </label>
            }

        <InputNumber @bind-Value="@userNWD" style="width:80px" @onkeydown="@EnterFinal"></InputNumber> </p>

        <p style="height:5px"></p>

        <p>Najmniejsza Wspólna Wielokrotność :
        @if (nwwList.Count != 1)
        {
            for (int i = 0; i < nwwList.Count; i++)
            {
                var j = i;
                <InputNumber @bind-Value="@nwwUserList[j]" style="width:50px"></InputNumber>
                if (i != nwwList.Count-1)
                {
                    <label> * </label>
                }
            }
            <label> = </label>
        }
        <InputNumber @bind-Value="@userNWW" style="width:80px" @onkeydown="@EnterFinal"></InputNumber></p>

        <p style="height:5px"></p>

        <button class="confbtn" @onclick="ConfirmFinal">Potwierdź</button>
    }

    <p style="height:5px"></p>
    <p>@message</p>

    <p>@hint[0]</p>
    <p>@hint[1]</p>


    <p style="height:5px"></p>
    <p>Wynik: @good / @all </p>

}else
{
        <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
        <p style="height:10px"></p>
        <h4>Twój wynik to: @good / @all </h4>

        <p style="height:20px"></p>
        <button class="backbtn" @onclick="GoBack">Cofnij</button>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    int good = 0;
    int all = 0;
    private string message1 = "";
    private string message2 = "";

    private string message = "";

    private string[] hint = ["", ""];

    private bool num1 = false;
    private bool num2 = false;

    private bool part2 = false;
    private int userNWD;
    private int userNWW;


    private List<int> nwdList = new List<int>();
    private List<int> nwwList = new List<int>();

    private List<int> nwdUserList = new List<int>();
    private List<int> nwwUserList = new List<int>();


    private async Task Confirm1()
    {
        var userGivenNum = userNumbers1[numberNumbers1];
        var lastNum = divNumbers1[divNumbers1.Count - 1];
        if (lastNum % userGivenNum == 0)
        {
            for (int i = 2; i < userGivenNum; i++)
            {
                if (lastNum % i == 0)
                {
                    message1 = "Prawie! Istnieje mniejszy dzielnik tej liczby";
                    return;
                }
            }

            message1 = "Dobrze!";

            divNumbers1.Add( lastNum / userGivenNum);

            if(lastNum/userGivenNum ==1)
            {
                message1 += " Ten numer skończony";
                num1 = true;
                userNumbers1.Add(1);
                CheckPart2();
                await Task.Delay(1000);
                this.StateHasChanged();
            }else
            {
                numberNumbers1++;
                userNumbers1.Add(0);
                await Task.Delay(1000);
                this.StateHasChanged();
                message1 = "";
            }
        }else
        {
            await WrongNumber1();
        }
    }

    private async Task Confirm2()
    {
        var userGivenNum = userNumbers2[numberNumbers2];
        var lastNum = divNumbers2[divNumbers2.Count - 1];
        if (lastNum % userGivenNum == 0)
        {
            for (int i = 2; i < userGivenNum; i++)
            {
                if (lastNum % i == 0)
                {
                    message2 = "Prawie! Istnieje mniejszy dzielnik tej liczby";
                    return;
                }
            }

            message2 = "Dobrze!";

            divNumbers2.Add(lastNum / userGivenNum);

            if (lastNum / userGivenNum == 1)
            {
                message2 += " Ten numer skończony";
                num2 = true;
                userNumbers2.Add(1);
                CheckPart2();
                await Task.Delay(1000);
                this.StateHasChanged();
            }
            else
            {
                numberNumbers2++;
                userNumbers2.Add(0);
                await Task.Delay(1000);
                this.StateHasChanged();
                message2 = "";
            }
        }
        else
        {
            await WrongNumber2();
        }
    }

    private void CheckPart2()
    {
        if(num1==true && num2==true)
        {
            part2 = true;
            fillCheckNumbers();
            message1 = "";
            message2 = "";
        }else
        {
            part2 = false;
        }
    }


    private async Task ConfirmFinal()
    {
        if (userNWD == anwserNWD && userNWW == anwserNWW)
        {
            await GoodNumber();
        }else
        {
            await CheckHints();
        }
    }

    private async Task GoodNumber()
    {
        good++;
        all++;
        message = "Dobrze!";
        this.StateHasChanged();
        if (all >= 10)
        {
            ready = false;
            await Task.Delay(1500);
            await UpdateUserScore();
            message = "";
            this.StateHasChanged();
            return;
        }

        await Task.Delay(1500);
        PrepareNewGame();
        message = "";
        part2 = false;
        num1 = false;
        num2 = false;
        message1 = "";
        message2 = "";
        userNWD = 0;
        userNWW = 0;
        nwdList = new List<int>();
        nwwList = new List<int>();
        nwdUserList = new List<int>();
        nwwUserList = new List<int>();
        hint = ["", ""];

        this.StateHasChanged();

    }
    private async Task WrongNumber1()
    {
        all++;
        message1 = "Liczba nie dzieli się przez tą liczbę! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        message1 = "";
    }
    private async Task WrongNumber2()
    {
        all++;
        message2 = "Liczba nie dzieli się przez tą liczbę! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        message2 = "";
    }

   

    public async Task Enter1(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Task.Delay(50);
            await Confirm1();
        }
    }

    public async Task Enter2(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Task.Delay(50);
            await Confirm2();
        }
    }

    public async Task EnterFinal(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Task.Delay(50);
            await ConfirmFinal();
        }
    }

    public void fillCheckNumbers()
    {
        List<int> ex1List = new List<int>();
        List<int> ex2List = new List<int>();

        ex1List.AddRange(userNumbers1);
        ex2List.AddRange(userNumbers2);

        ex1List.Remove(1);
        ex2List.Remove(1);


        foreach(var ex in ex1List)
        {
            if (ex2List.Contains(ex))
            {
                nwdList.Add(ex);
                ex2List.Remove(ex);
                nwdUserList.Add(0);
            }
            nwwList.Add(ex);
            nwwUserList.Add(0);
        }
        nwwList.AddRange(ex2List);
        foreach(var e in ex2List)
        {
            nwwUserList.Add(0);
        }
    }

    private async Task CheckHints()
    {
        bool bnwd = false;
        bool bnww = false;

        int privNWW = 1;
        int privNWD = 1;

        foreach (var nww in nwwUserList)
        {
            privNWW *= nww;
        }
        foreach (var nwd in nwdUserList)
        {
            privNWD *= nwd;
        }

        if(privNWD == anwserNWD)
        {
            if (userNWD == 0 || userNWD == anwserNWD)
            {
                userNWD = anwserNWD;
                bnwd = true;
            }else
            {
                hint[0] = "Liczby NWD dobrze wpisane, lecz wynik źle policzony. Wynik został poprawiony";
                userNWD = anwserNWD;   
            }
        }else
        {
            hint[0] = "Policz NWD poprzez pomnożenie liczb powtarzających się wśród czynników obu liczb";

        }

        if (privNWW == anwserNWW)
        {
            if (userNWW == 0 || userNWW == anwserNWW)
            {
                userNWW = anwserNWW;
                bnww = true;
            }
            else
            {
                hint[1] = "Liczby NWW dobrze wpisane, lecz wynik źle policzony. Wynik został poprawiony";
                userNWW = anwserNWW;
            }
        }else
        {
            hint[1] = "Policz NWW poprzez pomnożenie czynników obu liczbach. W przypadku czynników występujących w obu liczbach należy użyć ich do mnożenia tylko raz";
        }

        if(bnww==true && bnwd == true)
        {
            await Task.Delay(1500);
            await GoodNumber();
        }else
        {
            all++;
            message = "Spróbuj ponownie";
            this.StateHasChanged();

            await Task.Delay(1500);
            message1 = "";
        }
    } 
    
    private async Task UpdateUserScore()
    {
        var authenticationState = await authenticationStateTask;
        string username = authenticationState.User.Identity.Name;
        if (username != null)
        {
            var progrss = await userProgressService.GetProgressByAll(username, "Ułamki", "Gry");
            if (progrss != null)
            {
                good += progrss.good;
                all += progrss.all;
                var updated = new UserProgressDTO() { Id = progrss.Id, AccountId = progrss.AccountId, type = "Gry", unitName = "Ułamki", all = all, good = good };
                await userProgressService.UpdateProgress(updated);

            }
            else
            {
                await userProgressService.AddProgressByName(username, "Ułamki", "Gry", good, all);
            }

        }
    }


    private void GoBack()
    {
        NavManager.NavigateTo("ChooseGame/uname/Ułamki");
    }
}
