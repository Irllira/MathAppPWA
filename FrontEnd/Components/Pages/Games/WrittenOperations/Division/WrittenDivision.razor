@page "/WrittenDivison"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inherits WrittenDivisionBase;
@rendermode InteractiveServer
@inject NavigationManager NavManager


<PageTitle>Dzielenie Pisemne</PageTitle>



@if (ready == true)
{
    <h1>Podaj Poprawną Liczbę </h1>
    <p style="height:5px"></p>

    if (showHelp == true)
    {
        <right> 
            @if (exerciseNumber1[0] - '0'<exNum2)
            {
                <p style="font-size:20px">
                    Ile @exNum2 mieści się w @exerciseNumber1[0]@exerciseNumber1[2]?                
                    <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="finalAnwser[1]">
                </p>
                if (finalAnwser[1] != "")
                {
                    <p style="font-size:20px">
                        @finalAnwser[1] * @exerciseNumber2 =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help1[0]" />
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help1[1]" />
                    </p>
                }
                if (help1[0] != "" || help1[1]!="")
                {
                    <p style="font-size:20px">
                        @exerciseNumber1[0]@exerciseNumber1[2] -  @help1[0]@help1[1] =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[0]" />
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[1]" />
                    </p>

                    <p style="font-size:20px">
                        Którą kolejną cyfrę z liczby należy wziąść pod uwagę?
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[2]" />
                    </p>
                }

                if (numOne[2]!="")
                {
                   <p style="font-size:20px">
                        Ile @exNum2 mieści się w @numOne[0]@numOne[1]@numOne[2]?
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="finalAnwser[2]">
                    </p>  
                }
                if (finalAnwser[2] != "")
                {
                    <p style="font-size:20px">
                        @finalAnwser[2] * @exerciseNumber2 =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help2[0]" />
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help2[1]" />
                    </p>
                }

                if (help2[0] != "" || help2[1] != "")
                {
                    <p style="font-size:20px">
                        @numOne[0]@numOne[1]@numOne[2] -  @help2[0]@help2[1] =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numTwo[0]" />
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numTwo[1]" />
                    </p>
                }
            }else
            {
                <p style="font-size:20px">
                    Ile @exNum2 mieści się w @exerciseNumber1[0]?
                    <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="finalAnwser[0]">
                </p>

                if (finalAnwser[0]!="")
                {
                    <p style="font-size:20px">
                        @finalAnwser[0] * @exerciseNumber2 =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help1[0]" />
                    </p>
                }
                if(help1[0]!="")
                {
                    <p style="font-size:20px">
                        @exerciseNumber1[0] -  @help1[0] =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[0]" />
                    </p>

                    <p style="font-size:20px">
                        Którą kolejną cyfrę z liczby należy wziąść pod uwagę?
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[1]" />
                    </p>
                }
                if (numOne[1] != "")
                {
                    <p style="font-size:20px">
                        Ile @exNum2 mieści się w @numOne[0]@numOne[1]?
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="finalAnwser[1]">
                    </p>
                }

                if(finalAnwser[1]!="")
                {
                    <p style="font-size:20px">
                        @finalAnwser[1] * @exerciseNumber2 =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help2[0]" />
                    </p>
                }
                if( help2[0]!="")
                {
                    <p style="font-size:20px">
                        @numOne[0]@numOne[1] -  @help2[0] =
                        <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numTwo[0]" />
                    </p>
                }

            }
            <p style="height:5px"></p>
            @foreach(var h in hint)
            {
                <p>@h</p>
            }
            

    </right>
    }else
    {
        <right></right>
    }
   
    <p style="padding-left:60px">
        @for (int i = 0; i < howLong; i++)
        {
            var num = i;
            <input type="text" style="width:23px; height:30px; font-size:25px" maxlength="1" @bind-value="finalAnwser[num]">
        }
        
    </p>
    <p></p>
    
    <hr style="height:5px;border-width:0;color:black;background-color:black; width:20%">


    <p style="font-size:30px; padding-left:60px">
        <b> @exerciseNumber1 </b>    <label>&nbsp;&nbsp;</label><b> : &nbsp;@exerciseNumber2 </b>
    </p>           

    <p></p>
    
    int x = exerciseNumber1[0] - '0';

    // First help
    
    <p style="padding-left:40px">
    <label><b>-</b> &nbsp;</label>
    @if (x<exNum2)
    {
        @for (int i = 0; i < 2; i++)
        {
            var num = i;
            <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help1[num]">
            
        }
    }else
    {
         <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help1[0]">
    }
    </p>
    <hr style="margin-left:2.5em; width:10%; height:2px">

    // First excerciseNumber1
    <p style="padding-left:55px">
    @if (x<exNum2)
    {
        @for (int i = 0; i < 2; i++)
        {
            var num = i;
            <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[num]">
            
        }
    }else
    {
         <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[0]">
    }
    <label>&nbsp;</label>
         <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numOne[2]">

    </p>
    
    <!--    Second help     -->
    <p style="padding-left:40px">
    <label><b>-</b></label> <label style="padding-left:30px"></label>

    @if (x<exNum2)
    {
        @for (int i = 0; i < 2; i++)
        {
            var num = i;
            <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help2[num]">
            
        }
    }else
    {
         <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="help2[0]">
    }

    </p>
    <hr style="margin-left:2.5em; width:10%; height:2px">
    <!--     Second Number      -->
    <p style="padding-left:80px">

    @if (x<exNum2)
    {
        @for (int i = 0; i < 2; i++)
        {
            var num = i;
            <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numTwo[num]">
            
        }
    }else
    {
         <input type="text" style="width:20px; height:30px; font-size:25px" maxlength="1" @bind-value="numTwo[0]">
    }
    </p>

    <p style="height:10px"></p>
    <button class="confbtn" @onclick="Confirm">Potwierdź</button>
    <p></p>
    <button class="game2btns" @onclick="Help">Pomoc</button>

    <p style="height:5px"></p>
    <p>@message</p>
    <p style="height:5px"></p>

  


    <p>Wynik: @good / @all </p>
}
else
{
    <p><b>Koniec Gry!</b></p>
    <p>Twój wynik to: @good / @all </p>
    <p style="height:20px"></p>
    <button class="backbtn" @onclick="GoBack">Cofnij</button>
}


@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }


    int good = 0;
    int all = 0;
    private string message = "";
    private string theEnd = "";
    private string UserAnwser = "";

    // private List<string> finalNumber = new List<string>() { "", "", "" };
    private List<string> numOne = new List<string>() { "", "", "" };
    private List<string> numTwo = new List<string>() { "", "", "" };


    private List<string> finalAnwser = new List<string>() { "", "", "" };


    private List<string> help1 = new List<string>(){"",""};
    private List<string> help2 = new List<string>(){"",""};

    private bool showHelp = false;

    private List<string> hint =new List<string>(){"",""};


    private async Task Confirm()
    {
        if (finalAnwser[0] == "0")
        {
            finalAnwser[0]= "";            
        }
        if (finalAnwser[1] == "0" && finalAnwser[0] == "")
        {
            finalAnwser[1] = "";
        }

        await Task.Delay(100);
        UserAnwser = finalAnwser[0] + finalAnwser[1] + finalAnwser[2];
        if (UserAnwser == correctNumber.ToString())
        {
            await GoodNumber();
        }
        else
        {
            await WrongNumber();
        }
    }

    private async Task GoodNumber()
    {
        good++;
        all++;
        message = "Dobrze!";
        this.StateHasChanged();
        if (all >= 10)
        {
            theEnd = "Koniec gry!";
            ready = false;
            await Task.Delay(1500);
            await UpdateUserScore();
            message = "";
            this.StateHasChanged();
            return;
        }

        help1 = new List<string> { "", "" };
        help2 = new List<string> { "", "" };
        hint = new List<string> { "", "" };

        await Task.Delay(1500);
        PrepareNewGame();
        message = "";
        UserAnwser = "";
        showHelp = false;
        finalAnwser = new List<string> { "", "", "" };

        numTwo = new List<string>() { "", "", "" };
        numOne = new List<string>() { "", "", "" };

        this.StateHasChanged();
    }
    private async Task WrongNumber()
    {
        checkHints();

        all++;
        message = "Zła Odpowiedź! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        //   PrepareNewGame();
        message = "";
        //  this.StateHasChanged();
    }

    public async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Task.Delay(500);
            await Confirm();
        }
    }

    private void checkHints()
    {
        if (exerciseNumber1[0] - '0'<exNum2)
        {
            var firstHelp = help1[0] + help1[1];
            var firstCorr = (correctNumber - (correctNumber%10))/10 * exNum2;
            if (firstHelp == firstCorr.ToString())
            {
                hint[0] = "Pierwszy numer dobrze policzony,";
                var x = ((exNum1 - (exNum1 % 10)) / 10)-firstCorr;
                if(numOne[0]=="0"||numOne[0]=="=")
                {
                    numOne[0] = "";
                    if (numOne[1] == "" || numOne[1] == "=")
                        numOne[1] = "0";
                }
                var firstNum = numOne[0] + numOne[1];
                if(x.ToString() == firstNum)
                {
                    hint[0] += " odejmowanie dobrze policzone";
                    if(numOne[2]==(exNum1 % 10).ToString())
                    {
                        hint[0] += ", cyfra dobrze przepisana";

                        var secondHelp = help2[0] + help2[1];
                        if (secondHelp== ((correctNumber%10)*exNum2).ToString())
                        {
                            hint[1] = "Drugi numer dobrze policzony";
                            if (numTwo[0] == "0" || numTwo[0] == "=")
                            {
                                numTwo[0] = "";
                                if (numTwo[1] == "" || numTwo[1] == "=")
                                    numTwo[1] = "0";
                            }
                            var secondNum = numTwo[0] + numTwo[1];

                            if(secondNum == (correctNumber%exNum2).ToString())
                            {
                                hint[1] += ", odejmowanie dobrze policzone";
                            }
                            else
                            {
                                hint[1] += ", lecz odejmowanie źle policzone";                                                              
                            }

                        } else
                        {
                            if (hint[1] == "")
                            {
                                hint[1] = "Drugi numer źle policzony";
                            }else
                            {
                                hint[1] = "Drugi numer powinien wynosić "+(correctNumber%10)*exNum2;                                
                            }                            
                        }
                    }else
                    {
                        hint[0] += ", lecz cyfra źle przepisana";
                    }


                }else
                {
                    hint[0] += " lecz odejmowanie źle policzone!";
                }
            }else
            {
                if (hint[0] == "")
                {
                    hint[0] = "Pierwszy numer źle policzony,";
                }else
                {
                    hint[0] = "Pierwszy numer powinien wynosić "+ firstCorr;
                }
            }
        }else
        {

        }
    }

    private void Help()
    {
        if (showHelp == true)
        {
            showHelp = false;
        }
        else
        {
            showHelp = true;
        }
    }

    private async Task UpdateUserScore()
    {
        var authenticationState = await authenticationStateTask;
        string username = authenticationState.User.Identity.Name;
        if (username != null)
        {
            var progrss = await userProgressService.GetProgressByAll(username, "Działania Pisemne", "Gry");
            if (progrss != null)
            {
                good += progrss.good;
                all += progrss.all;
                var updated = new UserProgressDTO() { Id = progrss.Id, AccountId = progrss.AccountId, type = "Gry", unitName = "Działania Pisemne", all = all, good = good };
                await userProgressService.UpdateProgress(updated);

            }
            else
            {
                await userProgressService.AddProgressByName(username, "Działania Pisemne", "Gry", good, all);
            }

        }
    }

    private void GoBack()
    {
        NavManager.NavigateTo("ChooseGame/uname/Działania Pisemne");
    }
}