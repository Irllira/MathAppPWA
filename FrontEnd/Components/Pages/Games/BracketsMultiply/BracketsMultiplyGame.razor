@page "/BracketMulti"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inherits BracketsMultiplyBase;
@inject NavigationManager NavManager
@rendermode InteractiveServer


@if(ready==true)
{
    
   <h1 style="text-align:center">Którą Liczbę można wyciągnąć przed nawias </h1>
   <p style="height:10px"></p>
    <left>
   <h2><b> @excercise =
   </b></h2>
   <h2><b>
            <InputText @bind-Value="userInput[0]" style="width:50px; font-size:20px"/> x<sup>2</sup>
            <InputText @bind-Value="userSymbols[0]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userInput[1]" style="width:50px; font-size:20px" />  x
            <InputText @bind-Value="userSymbols[1]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userInput[2]" style="width:50px; font-size:20px" />  x
            <InputText @bind-Value="userSymbols[2]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userInput[3]" style="width:50px; font-size:20px" />
        =     
   </b> </h2>
    <h2><b>
         =
            <InputText @bind-Value="userFinalInput[0]" style="width:50px; font-size:20px"/> x<sup>2</sup>
            <InputText @bind-Value="userFinalSymbols[0]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userFinalInput[1]" style="width:50px; font-size:20px" />  x
            <InputText @bind-Value="userFinalSymbols[1]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userFinalInput[2]" style="width:50px; font-size:20px" />

    </b></h2>
    <p style="height:10px"></p>

    <button class="confbtn" @onclick="Confirm">Potwierdź</button>
    <p></p>
    <button class="helpbtn" @onclick="Help">Pomoc</button>
    <p style="height:5px"></p>
    <p>@message</p>  
    <p style="height:5px"></p>

    <p style="height:5px"></p>

    <p>Wynik: @good / @all </p>
    </left>
    <right>
        @if(showHints==true){
            <h2>Pomoc: </h2>
            <h3>(Pamiętaj o symbolach)</h3>
            <p></p>
            
            <p style="font-size:25px">
                @excerciseNumbers[0] x * @excerciseNumbers[2] x = <InputText @bind-Value="userInput[0]" style="width:50px; font-size:20px" /> x<sup>2</sup>
            </p>
            <p style="font-size:25px">
                @excerciseNumbers[0] x *
                @if (symbols[1] == '-')
                {
                    <label> (- @excerciseNumbers[3])</label>
                }else
                {
                    <label> @excerciseNumbers[3] </label>
                }
                  = <InputText @bind-Value="userSymbols[0]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userInput[1]" style="width:50px; font-size:20px" /> x
            </p>
            <p style="font-size:25px">
                @if (symbols[0] == '-')
                {
                    <label> (- @excerciseNumbers[1])</label>
                }
                else
                {
                    <label> @excerciseNumbers[1] </label>
                }
                
                * @excerciseNumbers[2] x = <InputText @bind-Value="userSymbols[1]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userInput[2]" style="width:50px; font-size:20px" /> x
            </p>
            <p style="font-size:25px">

                @if (symbols[0] == '-')
                {
                    <label> (- @excerciseNumbers[1])</label>
                }
                else
                {
                    <label> @excerciseNumbers[1] </label>
                }
                 *

                @if (symbols[1] == '-')
                {
                    <label> (- @excerciseNumbers[3])</label>
                }
                else
                {
                    <label> @excerciseNumbers[3] </label>
                }
                =  <InputText @bind-Value="userSymbols[2]" style="width:30px; font-size:15px" /> <InputText @bind-Value="userInput[3]" style="width:50px; font-size:20px" />
            </p>
        }
        
        
        @foreach (var h in hints)
        {
            <p>@h</p>
        }
    </right>
}else
{
        <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
        <p style="height:10px"></p>
        <h4>Twój wynik to: @good / @all </h4>

        <p style="height:20px"></p>
        <button class="backbtn" @onclick="GoBack">Cofnij</button>
}



@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    int good = 0;
    int all = 0;
    private string message = "";
    private string theEnd = "";
    private string[] userInput = ["", "", "", ""];
    private string[] userSymbols = ["", "", ""];

    private string[] userFinalInput = ["", "", ""];
    private string[] userFinalSymbols = ["", ""];
    private string[] hints = ["", "",""];

    private bool showHints = false;

    private async Task Confirm()
    {
        if (userFinalInput[0] == FinalNumbers[0] + "" && userFinalInput[1] == Math.Abs(FinalNumbers[1]) + "" && userFinalInput[2] == Math.Abs(FinalNumbers[2]) + "" && CheckFinalSymbol() == true)
        {
            await GoodNumber();
        }
        else
        {
            await WrongNumber();
        }

    }


    private async Task GoodNumber()
    {
        good++;
        all++;
        message = "Dobrze!";
        this.StateHasChanged();
        if (all >= 10)
        {
            theEnd = "Koniec gry!";
            ready = false;
            await Task.Delay(1500);
            await UpdateUserScore();
            message = "";
            this.StateHasChanged();
            return;
        }

        await Task.Delay(1500);
        PrepareNewGame();
        message = "";

        userInput =[ "","","",""];
        userSymbols = ["", "", ""];
        userFinalInput = ["", "", ""];
        userFinalSymbols = ["", ""];
        hints = ["", "", ""];

        this.StateHasChanged();

    }
    private async Task WrongNumber()
    {
        all++;
        CheckHints();
        message = "Zła Odpowiedź! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        message = "";
    }
  

    private void CheckHints()
    {
        if(userInput[0]==excerciseNumbers[0]*excerciseNumbers[2]+"" && 
        ((userInput[1] == excerciseNumbers[0] * excerciseNumbers[3] + "" && userInput[2] == excerciseNumbers[1] * excerciseNumbers[2] + "") ||
        (userInput[2] == excerciseNumbers[0] * excerciseNumbers[3] + "" && userInput[1] == excerciseNumbers[1] * excerciseNumbers[2] + "")) &&
        userInput[3]==excerciseNumbers[1]*excerciseNumbers[3]+"")
        {
            hints[0] = "Pierwsze równanie dobrze wpisane";

        }else
        {
            hints[0] = "Pierwsze równanie źle wpisane";
        }

        if (CheckSymbol() == true)
        {
            hints[1] = "Znaki w pierwszym równaniu dobrze wpisane";
        }
        else
        {
            hints[1] = "Znaki równania niepoprawnie wpisane";
        }

        if(CheckFinalSymbol()==true)
        {
            hints[2] = "Znaki w drugim równaniu dobrze wpisane";
        }else
        {
            hints[2] = "Znaki w drugim równaniu niepoprawnie wpisane";
        }
    }

    private bool CheckSymbol()
    {
        /* var normal = true;
        if (userInput[1] == excercise[1] * excercise[2]+"")
            normal = false;

        //var s = false;
        if(symbols[0]=='+')
        {
            if(normal==true && userSymbols[0][0]!='+')
            {
                return false;
                }
            if (normal == false && userSymbols[1][0] != '+')
            {
                return false;
                }
            if(symbols[1]=='+')
            {
                if (normal == true && userSymbols[0][0] != '+')
                {
                    return false;
                    }
                if (normal == false && userSymbols[1][0] != '+')
                {
                    return false;
                    }
                }else
            {
                if (normal == true && userSymbols[0][0] != '-')
                {
                    return false;
                    }
                if (normal == false && userSymbols[1][0] != '-')
                {
                    return false;
                    }
                }
            }else
        {
            if (normal == true && symbols[0] == '-' && userSymbols[0][0] != '-')
            {
                return false;
                }
            if (normal == false && userSymbols[1][0] != '-')
            {
                return false;
                }
            if (symbols[1] == '+')
            {
                if (normal == true && userSymbols[0][0] != '-')
                {
                    return false;
                    }
                if (normal == false && userSymbols[1][0] != '-')
                {
                    return false;
                    }
                }
            else
            {
                if (normal == true && userSymbols[0][0] != '+')
                {
                    return false;
                    }
                if (normal == false && userSymbols[1][0] != '+')
                {
                    return false;
                    }
                }
            }

        return true;*/
        for (int i = 0; i < userSymbols.Length; i++)
        {
            if (userSymbols[i].Length == 0)
                return false;
        }

        if (((symbolsMid[0] == userSymbols[0][0]) && (symbolsMid[1] == userSymbols[1][0]) || (symbolsMid[0] == userSymbols[1][0]) && (symbolsMid[1] == userSymbols[0][0])) && userSymbols[2][0] == symbolsMid[2])
        {
            return true;
        }
        return false;
    }

    private bool CheckFinalSymbol()
    {
        for (int i = 0; i < userFinalSymbols.Length; i++)
        {
            if (userFinalSymbols[i].Length == 0)
                return false;
        }

        if (symbolsFinal[0] == userFinalSymbols[0][0] && symbolsFinal[1] == userFinalSymbols[1][0])
        {
            return true;
        }
        return false;

    }

    private void Help()
    {
        showHints = true;
    }  
    
    private async Task UpdateUserScore()
    {
        var authenticationState = await authenticationStateTask;
        string username = authenticationState.User.Identity.Name;
        if (username != null)
        {
            var progrss = await userProgressService.GetProgressByAll(username, "Wyrażenia algebraiczne", "Gry");
            if (progrss != null)
            {
                good += progrss.good;
                all += progrss.all;
                var updated = new UserProgressDTO() { Id = progrss.Id, AccountId = progrss.AccountId, type = "Gry", unitName = "Wyrażenia algebraiczne", all = all, good = good };
                await userProgressService.UpdateProgress(updated);

            }
            else
            {
                await userProgressService.AddProgressByName(username, "Wyrażenia algebraiczne", "Gry", good, all);
            }

        }
    }

    private void GoBack()
    {
        NavManager.NavigateTo("ChooseGame/uname/Wyrażenia algebraiczne");
    }
}
