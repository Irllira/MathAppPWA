@page "/Field"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer
@inherits FigureFieldBase;
@inject NavigationManager NavManager

<style>
    .container {
        position: relative;
        text-align: left;
        color: black;
    }

    .height {
        position: absolute;
        top: 150px;
        left: 130px;
        transform: translate(-50%, -50%);
    }

    .height90 {
        position: absolute;
        top: 150px;
        left: 100px;
        transform: translate(-50%, -50%);
    }

    .heightParall {
        position: absolute;
        top: 140px;
        left: 100px;
        transform: translate(-50%, -50%);
    }

    .base {
        position: absolute;
        bottom: 70px;
        left: 150px;
        transform: translate(-50%, -50%);
    }

    .baseSqe {
        position: absolute;
        bottom: 20px;
        left: 160px;
        transform: translate(-50%, -50%);
    }

    .wallSqr {
        position: absolute;
        bottom: 130px;
        left: 50px;
        transform: translate(-50%, -50%);
    }

    .baseRec {
        position: absolute;
        bottom: 40px;
        left: 150px;
        transform: translate(-50%, -50%);
    }

    .wallRec {
        position: absolute;
        bottom: 130px;
        left: 20px;
        transform: translate(-50%, -50%);
    }

    .trapBase1{
        position: absolute;
        bottom: 90px;
        left: 150px;
        transform: translate(-50%, -50%);
    }

    .trapBase2 {
        position: absolute;
        top: 88px;
        left: 150px;
        transform: translate(-50%, -50%);
    }

    .trapHeight{
        position: absolute;
        top: 130px;
        left: 110px;
        transform: translate(-50%, -50%);
    }

    .rombE
    {
        position: absolute;
        bottom: 110px;
        left: 150px;
        transform: translate(-50%, -50%);
    }

    .rombF {
        position: absolute;
        top: 152px;
        left: 138px;
        transform: translate(-50%, -50%);
    }

</style>

<PageTitle>Pole Figury</PageTitle>

<h1 style="text-align:center">Policz Pole Figury</h1>

@if(ready==true){
    <div class="container">
        <img src="@imgPath" />
    
        @switch (figure)
        {
            case "TriangleReg":
                <div class="height"> @numbers[1]</div>
                <div class="base"> @numbers[0]</div>
                break;
            case "Triangle90":
                <div class="height90"> @numbers[1]</div>
                <div class="base"> @numbers[0]</div>
                break;
            case "Rownoleglobok":
                <div class="heightParall"> @numbers[1]</div>
                <div class="base"> @numbers[0]</div>
                break;
            case "Kwadrat":
                <div class="wallSqr"> @numbers[0]</div>
                <div class="baseSqe"> @numbers[0]</div>
                break;
            case "Prostokat":
                <div class="wallRec"> @numbers[1]</div>
                <div class="baseRec"> @numbers[0]</div>
                break;
            case "Rab":
                <div class="rombF"> @numbers[1]</div>
                <div class="rombE"> @numbers[0]</div>
                break;
            case "Trapez":
                <div class="trapHeight"> @numbers[2]</div>
                <div class="trapBase1"> @numbers[1]</div>
                <div class="trapBase2"> @numbers[0]</div>
                break;
        }
    </div>

    @switch(phase)
    {
        case "ChooseFormula":
            <p> Z którego wzoru należy skorzystać? </p>
            <p style="height:5px"></p>
            var forms = formulas;
            Random rnd = new Random();
            rnd.Shuffle(forms);
            foreach(var f in forms)
            {
               <label style="padding-left:20px; padding-bottom:5px">
                    <button class="gamebtns" style="height:80px" @onclick="@(e => CheckForm(e, f))">
                        P =
                        @if(f.denominator=="")
                        {
                            @f.numerator                       
                        }else
                        {                        
                            <div class="frac">
                                <span> @f.numerator </span>
                                <span class="symbol"> / </span>
                                <span class="bottom"> @f.denominator </span>
                            </div>                           
                        }
                    </button>
                </label>
            }
            break;

        case "PickNbrs":

            if (formula.denominator =="")
            {
                <p><b>P = @formula.numerator </b></p>
                <p style="height:5px"></p>
                <p> P =
                    <InputNumber @bind-Value="userInput[0]" style="width:50px">  </InputNumber> *
                    <InputNumber @bind-Value="userInput[1]" style="width:50px">  </InputNumber>
                    =
                    <InputNumber @bind-Value="userAnwser" style="width:80px">  </InputNumber>
                </p>  

            }
            else
            {
                <p><b> P = 
                <div class="frac">
                    <span> @formula.numerator </span>
                    <span class="symbol"> / </span>
                    <span class="bottom"> @formula.denominator </span>
                </div>
                </b></p>
                if(formula.name == "Trapez")
                {
                    <p>
                        P = <div class="frac">
                            <span> ( <InputNumber @bind-Value="userInput[0]" style="width:50px"></InputNumber> + <InputNumber @bind-Value="userInput[1]" style="width:50px"> </InputNumber> ) *<InputNumber @bind-Value="userInput[2]" style="width:50px">  </InputNumber> </span>
                            <span class="symbol"> / </span>
                            <span class="bottom"> 2 </span>
                        </div>
                        =
                        <InputNumber @bind-Value="userAnwser" style="width:50px">  </InputNumber>
                    </p>
                }else
                {
                    <p>
                        P = <div class="frac">
                            <span> <InputNumber @bind-Value="userInput[0]" style="width:50px"></InputNumber> * <InputNumber @bind-Value="userInput[1]" style="width:50px">  </InputNumber> </span>
                            <span class="symbol"> / </span>
                            <span class="bottom"> 2 </span>
                        </div>
                        =
                        <InputNumber @bind-Value="userAnwser" style="width:50px">  </InputNumber>
                    </p>
                }
            }

            <p style="height:5px"></p>
           
            for (int i = 0; i < formula.symbolsNmbr; i++)
            {
                var j = i;
                <p>
                    @formula.symbols[i] = <InputNumber @bind-Value="userInput[j]" style="width:50px"></InputNumber>
                </p>
            }


            <button class="mainbtns" @onclick=Confirm>Potwierdź </button>
            break;
    }

    <p style="height:5px"></p>
    <p>@message</p>
   
    @foreach(var h in hints)
    {
        if(h!="")
        {
            <p style="padding-left:10px"> @h </p>
        }
    }
    

    <p style="height:5px"></p>
    <p>Wynik: @good / @all </p>
}else
{
    <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
    <p style="height:10px"></p>
    <h4>Twój wynik to: @good / @all </h4>

    <p style="height:20px"></p>
    <button class="backbtn" @onclick="GoBack">Cofnij</button>
}


@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private int[] userInput = new int[3];
    private double userAnwser;
    private string[] hints = new string[3];

    private Formula formula = new Formula();

    int good = 0;
    int all = 0;
    private string message = "";


    private async Task CheckForm(MouseEventArgs e, Formula form)
    {
        if(figure.Contains(form.name))
        {
            formula = form;
            message = "Dobry wzór!";
            await GoodForm();
        }else
        {
            message = "Nie ten wzór! Spróbuj jeszcze raz!";
        }
    }

    private async Task GoodForm()
    {
        await Task.Delay(1000);
        // PrepareNewGame();
        message = "";
        phase = "PickNbrs";
    }

    private async Task Confirm()
    {
        if (finalAnwser == userAnwser)
        {
            await GoodNumber();
        }
        else
        {
            await WrongNumber();
        }
    }

    private async Task GoodNumber()
    {
        good++;
        all++;
        message = "Dobrze!";
        this.StateHasChanged();
        if (all >= 10)
        {
            ready = false;
            await Task.Delay(1500);
            await UpdateUserScore();
            message = "";
            this.StateHasChanged();
            return;
        }

        await Task.Delay(1500);
        PrepareNewGame();
        message = "";
        userAnwser = 0;
        userInput = [0, 0, 0];
        hints = ["", "", ""];

        this.StateHasChanged();

    }
    private async Task WrongNumber()
    {
        CheckHints();
        all++;
        message = "Zła Odpowiedź! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        message = "";
    }

    private void CheckHints()
    {
        for (int i = 0; i < formula.symbolsNmbr; i++)
        {
            if (numbers[i] == userInput[i])
            {
                hints[i] = formula.symbols[i] + " dobrze wpisane";
            }else
            {
                hints[i] = formula.symbols[i] + " źle wpisane";
            }
        }
    }

    private async Task UpdateUserScore()
    {
        var authenticationState = await authenticationStateTask;
        string username = authenticationState.User.Identity.Name;
        if (username != null)
        {
            var progrss = await userProgressService.GetProgressByAll(username, "Geometria", "Gry");
            if (progrss != null)
            {
                good += progrss.good;
                all += progrss.all;
                var updated = new UserProgressDTO() { Id = progrss.Id, AccountId = progrss.AccountId, type = "Gry", unitName = "Geometria", all = all, good = good };
                await userProgressService.UpdateProgress(updated);

            }
            else
            {
                await userProgressService.AddProgressByName(username, "Geometria", "Gry", good, all);
            }

        }
    }


    private void GoBack()
    {
        NavManager.NavigateTo("ChooseGame/uname/Geometria");
    }

}

