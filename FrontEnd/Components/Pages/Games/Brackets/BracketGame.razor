@page "/Bracket/{type}"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inherits BracketBase;
@inject NavigationManager NavManager
@rendermode InteractiveServer


@if(ready==true)
{  
    if (type == "from")
    {
        if(part == "first"){
            <h1 style="text-align:center">Którą Liczbę można wyciągnąć przed nawias </h1>
            <p style="height:10px"></p>
            <h2><b> @excercise = </b></h2>
            <p style="height:5px"></p>
            Random rnd = new Random();
            int correct = rnd.Next(0,wrongAnwsers.Count);
            int j = 0;
            for (int i=0;i<wrongAnwsers.Count()+1;i++)
            {
               if (i == correct)
               {
                  <button class="btn btn-primary" @onclick="GoodFirst">@modifier</button> <label style="padding-left:20px"></label>
               }else
               {
                   <button class="btn btn-primary" @onclick ="WrongNumber">@wrongAnwsers[j]</button> <label style="padding-left:20px"></label>
                   j++;
               }
            }
            <p style="height:5px"></p>
            <p>@message</p>
            <p style="height:5px"></p>
            <p>Wynik: @good / @all </p>
        }else
        {
            <left>
            <h1 style="text-align:center">Uzupełnij </h1>
            <p style="height:10px"></p>
            <h2><b> @excercise = @modifier (<InputText @bind-Value="userInput1" style="width:40px; font-size:20px" /> x @sym <InputText @bind-Value="userInput2" style="width:40px; font-size:20px"/>) </b></h2>
            <p style="height:5px"></p>

            <button class="confbtn" @onclick="Confirm">Potwierdź</button> <p></p>
            <button class="helpbtn" @onclick="ShowHelp"> Pomoc </button>
            <p style="height:5px"></p>
            <p>@message</p>
            <p style="height:5px"></p>
            <p>Wynik: @good / @all </p>
            </left>
        }
        
        <right>
            <p style="height:50px"></p>
            @if(hint1>1 || ShowHint == true||hint2>1 )
            {
                <h3>Pomoc:</h3>
            }
            @if(hint1>1|| ShowHint == true)
            {
                <p style="font-size:25px">Wskazówka: @excerciseNumber1 : @modifier = <InputText @bind-Value="userInput1" style="width:40px;font-size:20px" /></p>
            }
            @if(hint2>1 || ShowHint == true)
            {
                <p style="font-size:25px">Wskazówka: @excerciseNumber2 : @modifier = <InputText @bind-Value="userInput2" style="width:40px;font-size:20px" /></p>
            }
        </right>
       
    }else
    {
        <left>
            <h1 style="text-align:center">Pozbądź się nawiasu </h1>
            <p style="height:10px"></p>
            <h2><b> @excercise <InputText @bind-Value="userInput1" style="width:40px; font-size:20px" /> x <InputText @bind-Value="userSymb" style="width:20px; font-size:20px;" maxlength="1"/> <InputText @bind-Value="userInput2" style="width:40px; font-size:20px"/> </b></h2>
            <p style="height:5px"></p>
            <button class="confbtn" @onclick="Confirm">Potwierdź</button><p></p>
            <button class="helpbtn" @onclick="ShowHelp"> Pomoc </button>

            <p style="height:5px"></p>
            <p>@message</p>
            <p style="height:5px"></p>
            <p>Wynik: @good / @all </p>
        </left>
         <right>
            <p style="height:50px"></p>

            @if(hint1>1 || ShowHint == true||hint2>1 ||hint3>1)
            {
                <h3>Pomoc:</h3>
            }
            @if(hint1>1 || ShowHint == true)
            {
                <p style="font-size:25px"> @modifier * @excerciseNumber1 = <InputText @bind-Value="userInput1" style="width:40px;font-size:20px" /></p>
            }
            @if(hint2>1 || ShowHint == true)
            {
                <p style="font-size:25px"> @Math.Abs(modifier) * @excerciseNumber2 = <InputText @bind-Value="userInput2" style="width:40px;font-size:20px" /></p>
            }
            @if(hint3>1|| ShowHint == true)
            {
                char sym1;
                char sym2 = sym;
                if(modifier<0)
                {
                    sym1 = '-';
                }else
                {
                    sym1 = '+';
                }                

                <p style="font-size:25px"> Znak:  (@sym1) * (@sym2) = <InputText @bind-Value="userSymb" style="width:40px;font-size:20px" /></p>
            }
         </right>
    }
    
}else
{
        <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
        <p style="height:10px"></p>
        <h4>Twój wynik to: @good / @all </h4>

        <p style="height:20px"></p>
        <button class="backbtn" @onclick="GoBack">Cofnij</button>
}



@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    int good = 0;
    int all = 0;
    private string message = "";
    private string theEnd = "";
    private string userInput1 = "";
    private string userInput2 = "";
    protected int hint1=0;
    protected int hint2=0;
    protected int hint3=0;

    protected bool ShowHint = false;

    protected string userSymb = "";

    private async Task Confirm()
    {
        if (type == "from")
        {
            if (userInput1 == excerciseNumber1 / modifier + "" && userInput2 == excerciseNumber2 / modifier + "")
            {
                await GoodNumber();
            }
            else
            {
                if (userInput1 != excerciseNumber1 / modifier + "")
                    hint1++;
                if (userInput2 != excerciseNumber2 / modifier + "")
                    hint2++;
                await WrongNumber();
            }
        }
        else
        {
            var checkSym = CheckSymbol();
            if (userInput1 == excerciseNumber1 * modifier + "" && userInput2 == Math.Abs(excerciseNumber2 * modifier) + "" &&  checkSym== true)
            {
                await GoodNumber();
            }
            else
            {
                if (userInput1 != excerciseNumber1 * modifier + "")
                    hint1++;
                if (userInput2 != Math.Abs(excerciseNumber2 * modifier) + "")
                    hint2++;
                if (checkSym == false)
                    hint3++;
                await WrongNumber();
            }
        }
    }

    private async Task GoodFirst()
    {
        message = "Dobrze! Teraz wyciągnij tę liczbę przed nawias!";
        await Task.Delay(1000);

        part = "final";
        message = "";
        ShowHint = false;
    }


    private async Task GoodNumber()
    {
        good++;
        all++;
        message = "Dobrze!";
        this.StateHasChanged();
        if (all >= 10)
        {
            theEnd = "Koniec gry!";
            ready = false;
            await Task.Delay(1500);
            await UpdateUserScore();
            message = "";
            this.StateHasChanged();
            return;
        }

        await Task.Delay(1500);
        PrepareNewGame();
        message = "";
        hint1 = 0;
        hint2 = 0;
        hint3 = 0;
        userInput1 = "";
        userInput2 = "";
        userSymb = "";
        ShowHint = false;

        this.StateHasChanged();

    }
    private async Task WrongNumber()
    {
        all++;
        message = "Zła Odpowiedź! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        message = "";
    }
    private bool CheckSymbol()
    {
        //var s = false;
        if(modifier*excerciseNumber1>0 && sym==userSymb[0])
        {
            return true;
        }
        if(modifier*excerciseNumber1<0)
        {
            if(sym=='+')
            {
                if (userSymb == "-")
                    return true;

            }else
            {
                if (userSymb == "+")
                    return true;
            }
        }
        return false;
    }


    private void ShowHelp()
    {
        ShowHint = true;
    }
    private async Task UpdateUserScore()
    {
        var g = good;
        var a = all;
        var authenticationState = await authenticationStateTask;
        string username = authenticationState.User.Identity.Name;
        if (username != null)
        {
            var progrss = await userProgressService.GetProgressByAll(username, "Wyrażenia algebraiczne", "Gry");
            if (progrss != null)
            {
                g += progrss.good;
                a += progrss.all;
                var updated = new UserProgressDTO() { Id = progrss.Id, AccountId = progrss.AccountId, type = "Gry", unitName = "Wyrażenia algebraiczne", all = a, good = g };
                await userProgressService.UpdateProgress(updated);

            }
            else
            {
                await userProgressService.AddProgressByName(username, "Wyrażenia algebraiczne", "Gry", good, all);
            }

        }
    }
    
    private void GoBack()
    {
        NavManager.NavigateTo("ChooseGame/uname/Wyrażenia algebraiczne");
    }
    
}
