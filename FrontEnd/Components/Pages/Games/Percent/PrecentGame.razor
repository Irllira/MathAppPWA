@page "/prec/{type}"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using global::FrontEnd.Components.Classes
@using global::FrontEnd.Components.Pages.Games.Percent
@rendermode InteractiveServer
@inherits PrecentBase;
@inject NavigationManager NavManager


<PageTitle>Procenty</PageTitle>


@if(ready==true)
{
    if(type=="proc"){
        if(sym==0){
            double p = (procent - 100);
            <h1 style="text-align:center">Znajdź liczbę o @p % większą od liczby @excerciseNumber1</h1>
        }else{
            double p = (100 - procent);
            <h1 style="text-align:center">Znajdź liczbę o @p % mniejszą od liczby @excerciseNumber1</h1>       
        }
        <p style="height:5px"></p>

        <h2>@excerciseNumber1 - 100%</h2> <p></p>
        <h2> X <label style="padding:10px"></label>- @procent %</h2>
        <p style="height:5px"></p>

        <h2><b> X = </b>
        <div class="frac"> 
            <span><InputNumber @bind-Value="userExcerciseNum1" @onkeydown="@Enter" style="width:60px;font-size:15px" /> * <InputNumber @bind-Value="userProcent" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userProcentDen" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span> 
        </div>
         =
        <div class="frac"> 
            <span><InputNumber @bind-Value="userMiddle" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userProcentDen" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span> 
        </div>
         =
        <InputNumber @bind-Value="userFinal" @onkeydown="@Enter" style="width:100px;font-size:30px"/>
        </h2>
    }else
    {
        <h1 style="text-align:center">Jakim procentem liczby @excerciseNumber1 jest liczba @excerciseNumber2</h1>        
        <p style="height:5px"></p>

        <h2> @excerciseNumber1 - 100%</h2> <p></p>
        <h2> @excerciseNumber2 - X</h2>
        <p style="height:5px"></p>

        <h2><b> X = </b>
        <div class="frac"> 
            <span><InputNumber @bind-Value="userExcerciseNum1" @onkeydown="@Enter" style="width:60px;font-size:15px" /> * <InputNumber @bind-Value="userProcent" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userExcerciseNum2" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span> 
        </div>
         =
        <div class="frac"> 
            <span><InputNumber @bind-Value="userMiddle" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userExcerciseNum2" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span> 
        </div>
         =
        <InputNumber @bind-Value="userFinal" @onkeydown="@Enter" style="width:100px;font-size:30px"/>
        </h2>
    }
    <p style="height:5px"></p>
    <button class="confbtn" @onclick="CheckAnwsers">Potwierdź</button>
    <p>@gameBase.message</p>
    <p style="height:5px"></p>

    foreach(var h in hint)
    {
        <p>@h</p>  
    }
    <p style="height:5px"></p>
    <p>Wynik: @gameBase.good / @gameBase.all </p>
}
else
{
    <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
    <p style="height:10px"></p>
    <h4>Twój wynik to: @gameBase.good / @gameBase.all </h4>
}

<p style="height:50px"></p>
<button class="backbtn" @onclick="GoBack">Cofnij</button>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    GamesBase gameBase = new GamesBase("Procenty", "Gry");

    protected int userExcerciseNum1 = 0;
    protected int userExcerciseNum2 = 0;

    protected double userProcent = 0;
    protected int userProcentDen = 0;
    protected int userMiddle = 0;
    protected double userFinal = 0;

    private List<string> hint =new List<string>(){"",""};

    private async Task CheckAnwsers()
    {
        if (type =="proc") {
            if (userFinal == excerciseNumber2)
            {
                await gameBase.GoodAnswer();
                if (gameBase.all >= 10)
                {
                    ready = false;
                    await gameBase.UpdateUserScore(authenticationStateTask, userProgressService);
                    return;
                }
                PrepareNewGame();
                hint = new List<string>() { "", "" };

                userExcerciseNum1 = 0;
                userProcent = 0;
                userProcentDen = 0;
                userMiddle = 0;
                userFinal = 0;
            }
            else
            {
                await gameBase.WrongAnswer();
                Hints();
            }
        }
        else
        {
            if (Math.Round(userFinal) == Math.Round(procent))
            {
                await gameBase.GoodAnswer();
                if (gameBase.all >= 10)
                {
                    ready = false;
                    await gameBase.UpdateUserScore(authenticationStateTask, userProgressService);
                    return;
                }
                PrepareNewGame();
                hint = new List<string>() { "", "" };

                userExcerciseNum1 = 0;
                userProcent = 0;
                userProcentDen = 0;
                userMiddle = 0;
                userFinal = 0;
            }
            else
            {
                await gameBase.WrongAnswer();
                Hints();
            }
        }
    }


    private void Hints()
    {
        if (type == "proc")
        {
            if (((userExcerciseNum1 == excerciseNumber1 && userProcent == procent) || (userExcerciseNum1 == procent && userProcent == excerciseNumber1)) && userProcentDen == 100)
            {
                hint[0] = "Pierwsza równość poprawnie uzupełniona!";
                if (userMiddle == excerciseNumber1 * procent)
                {
                    hint[1] = "Środkowa wartość dobrze policzona";
                }
                else
                {
                    if (hint[1] == "")
                    {
                        hint[1] = "Środkowa wartość źle policzona";
                    }
                    else
                    {
                        hint[1] = "Środkowa wartość powinna wynosić " + excerciseNumber1 * procent + ", ponieważ " + excerciseNumber1 + " * " + procent + " = " + excerciseNumber1 * procent;
                    }
                }

            }
            else
            {
                if (hint[0] == "")
                {
                    hint[0] = "Pierwsza równość źle uzupełniona!";
                }
                else
                {
                    hint[0] = "Poprawiono pierwszą równość";
                    userExcerciseNum1 = excerciseNumber1;
                    userProcent = procent;
                    userProcentDen = 100;
                }
            }
        }else
        {
            if (((userExcerciseNum2 == excerciseNumber1 && userProcent == 100) || (userExcerciseNum2 == 100 && userProcent == excerciseNumber1)) && userExcerciseNum1 == excerciseNumber2)
            {
                hint[0] = "Pierwsza równość poprawnie uzupełniona!";
                if (userMiddle == excerciseNumber2 * 100)
                {
                    hint[1] = "Środkowa wartość dobrze policzona";
                }
                else
                {
                    if (hint[1] == "")
                    {
                        hint[1] = "Środkowa wartość źle policzona";
                    }
                    else
                    {
                        hint[1] = "Środkowa wartość powinna wynosić " + excerciseNumber2 * 100 + ", ponieważ " + excerciseNumber2 + " * 100 = " + excerciseNumber2 * 100;
                    }
                }

            }
            else
            {
                if (hint[0] == "")
                {
                    hint[0] = "Pierwsza równość źle uzupełniona!";
                }
                else
                {
                    hint[0] = "Poprawiono pierwszą równość";
                    userExcerciseNum1 = Convert.ToInt32(excerciseNumber2);
                    userProcent = 100;
                    userExcerciseNum2 =  excerciseNumber1;
                }
            }
        }
    }

    public async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Task.Delay(500);
            await CheckAnwsers();
        }
    }

    private async Task GoBack()
    {
        await gameBase.UpdateUserScore(authenticationStateTask, userProgressService);
        NavManager.NavigateTo("ChooseGame/uname/Liczby Naturalne");
    }
}
