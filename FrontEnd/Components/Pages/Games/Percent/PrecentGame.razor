@page "/prec/{type}"
@using DTO.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer
@inherits PrecentBase;
@inject NavigationManager NavManager


<PageTitle>Procenty</PageTitle>


@if(ready==true)
{
    if(type=="proc"){
        if(sym==0){
            double p = (procent - 100);
            <h1 style="text-align:center">Znajdź liczbę o @p % większą od liczby @excerciseNumber1</h1>
        }else{
            double p = (100 - procent);
            <h1 style="text-align:center">Znajdź liczbę o @p % mniejszą od liczby @excerciseNumber1</h1>       
        }
        <p style="height:5px"></p>

        <h2>@excerciseNumber1 - 100%</h2> <p></p>
        <h2> X <label style="padding:10px"></label>- @procent %</h2>
        <p style="height:5px"></p>

        <h2><b> X = </b>
        <div class="frac"> 
            <span><InputNumber @bind-Value="userExcerciseNum1" @onkeydown="@Enter" style="width:60px;font-size:15px" /> * <InputNumber @bind-Value="userProcent" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userProcentDen" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span> 
        </div>
         =
        <div class="frac"> 
            <span><InputNumber @bind-Value="userMiddle" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userProcentDen" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span> 
        </div>
         =
        <InputNumber @bind-Value="userFinal" @onkeydown="@Enter" style="width:100px;font-size:30px"/>
        </h2>
    }else
    {
        <h1 style="text-align:center">Jakim procentem liczby @excerciseNumber1 jest liczba @excerciseNumber2</h1>        
        <p style="height:5px"></p>

        <h2> @excerciseNumber1 - 100%</h2> <p></p>
        <h2> @excerciseNumber2 - X</h2>
        <p style="height:5px"></p>

        <h2><b> X = </b>
        <div class="frac"> 
            <span><InputNumber @bind-Value="userExcerciseNum2" @onkeydown="@Enter" style="width:60px;font-size:15px" /> * <InputNumber @bind-Value="userProcent" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userExcerciseNum1" @onkeydown="@Enter" style="width:60px;font-size:15px" /></span> 
        </div>
         =
        <div class="frac"> 
            <span><InputNumber @bind-Value="userMiddle" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span>
            <span class="symbol">/</span>
            <span class="bottom"> <InputNumber @bind-Value="userExcerciseNum1" @onkeydown="@Enter" style="width:60px;font-size:15px" /> </span> 
        </div>
         =
        <InputNumber @bind-Value="userFinal" @onkeydown="@Enter" style="width:100px;font-size:30px"/>
        </h2>
    }
    <p style="height:5px"></p>
    <button class="confbtn" @onclick="CheckAnwsers">Potwierdź</button>
    <p>@message</p>
    <p style="height:5px"></p>

    foreach(var h in hint)
    {
        <p>@h</p>  
    }
    <p style="height:5px"></p>
    <p>Wynik: @good / @all </p>
}
else
{
    <h2 style="text-align:center"><b>Koniec Gry!</b></h2>
    <p style="height:10px"></p>
    <h4>Twój wynik to: @good / @all </h4>

    <p style="height:20px"></p>
    <button class="backbtn" @onclick="GoBack">Cofnij</button>
}


@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    int good = 0;
    int all = 0;

    protected int userExcerciseNum1 = 0;
    protected int userExcerciseNum2 = 0;


    protected double userProcent = 0;
    protected int userProcentDen = 0;
    protected int userMiddle = 0;

    protected double userFinal = 0;


    private string message = "";
    private string theEnd = "";
    private List<string> hint =new List<string>(){"",""};


    private async Task CheckAnwsers()
    {
        if (type =="proc") {
            if (userFinal == excerciseNumber2)
            {
                await GoodNumber();
            }
            else
            {
                await WrongNumber();
            }
        }
        else
        {
            if (Math.Round(userFinal) == Math.Round(procent))
            {
                await GoodNumber();
            }
            else
            {
                await WrongNumber();
            }
        }
    }

    private async Task GoodNumber()
    {
        good++;
        all++;
        message = "Dobrze!";
        this.StateHasChanged();
        if (all >= 10)
        {
            theEnd = "Koniec gry!";
            ready = false;
            await Task.Delay(1500);
            await UpdateUserScore();
            message = "";
            this.StateHasChanged();
            return;
        }

        await Task.Delay(1500);
        PrepareNewGame();
        message = "";
        hint = new List<string>() { "", "" };

        userExcerciseNum1 = 0;
        userProcent = 0;
        userProcentDen = 0;
        userMiddle = 0;
        userFinal = 0;

        this.StateHasChanged();
    }

    private async Task WrongNumber()
    {
        Hints();
        all++;
        message = "Zła Odpowiedź! Spróbuj ponownie";
        this.StateHasChanged();

        await Task.Delay(1500);
        message = "";

    }

    private void Hints()
    {
        if (type == "proc")
        {
            if (((userExcerciseNum1 == excerciseNumber1 && userProcent == procent) || (userExcerciseNum1 == procent && userProcent == excerciseNumber1)) && userProcentDen == 100)
            {
                hint[0] = "Pierwsza równość poprawnie uzupełniona!";
                if (userMiddle == excerciseNumber1 * procent)
                {
                    hint[1] = "Środkowa wartość dobrze policzona";
                }
                else
                {
                    if (hint[1] == "")
                    {
                        hint[1] = "Środkowa wartość źle policzona";
                    }
                    else
                    {
                        hint[1] = "Środkowa wartość powinna wynosić " + excerciseNumber1 * procent + ", ponieważ " + excerciseNumber1 + " * " + procent + " = " + excerciseNumber1 * procent;
                    }
                }

            }
            else
            {
                if (hint[0] == "")
                {
                    hint[0] = "Pierwsza równość źle uzupełniona!";
                }
                else
                {
                    hint[0] = "Poprawiono pierwszą równość";
                    userExcerciseNum1 = excerciseNumber1;
                    userProcent = procent;
                    userProcentDen = 100;
                }
            }
        }else
        {
             if (((userExcerciseNum2 == excerciseNumber2 && userProcent == 100) || (userExcerciseNum2 == 100 && userProcent == excerciseNumber2)) && userExcerciseNum2 == excerciseNumber2)
            {
                hint[0] = "Pierwsza równość poprawnie uzupełniona!";
                if (userMiddle == excerciseNumber2 * 100)
                {
                    hint[1] = "Środkowa wartość dobrze policzona";
                }
                else
                {
                    if (hint[1] == "")
                    {
                        hint[1] = "Środkowa wartość źle policzona";
                    }
                    else
                    {
                        hint[1] = "Środkowa wartość powinna wynosić " + excerciseNumber2 * 100 + ", ponieważ " + excerciseNumber2 + " * 100 = " + excerciseNumber2 * 100;
                    }
                }

            }
            else
            {
                if (hint[0] == "")
                {
                    hint[0] = "Pierwsza równość źle uzupełniona!";
                }
                else
                {
                    hint[0] = "Poprawiono pierwszą równość";
                    userExcerciseNum1 = excerciseNumber1;
                    userProcent = procent;
                    userProcentDen = 100;
                }
            }
        }
    }

    public async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Task.Delay(500);
            await CheckAnwsers();
        }
    }

     private async Task UpdateUserScore()
    {
        var authenticationState = await authenticationStateTask;
        string username = authenticationState.User.Identity.Name;
        if (username != null)
        {
            var progrss = await userProgressService.GetProgressByAll(username, "Liczby Naturalne", "Gry");
            if (progrss != null)
            {
                good += progrss.good;
                all += progrss.all;
                var updated = new UserProgressDTO() { Id = progrss.Id, AccountId = progrss.AccountId, type = "Gry", unitName = "Liczby Naturalne", all = all, good = good };
                await userProgressService.UpdateProgress(updated);

            }
            else
            {
                await userProgressService.AddProgressByName(username, "Liczby Naturalne", "Gry", good, all);
            }

        }
    }


    private void GoBack()
    {
        NavManager.NavigateTo("ChooseGame/uname/Liczby Naturalne");
    }
}
